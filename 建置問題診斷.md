# APK 建置問題診斷報告

## 問題摘要

經過多次嘗試，自動建置 APK 遇到環境變數設定問題。PowerShell 中設定的環境變數無法正確傳遞給 Cordova 和 Gradle 子程序。

## 嘗試過的方法

1. ✅ **執行自動建置腳本**
   - 狀態：批次檔字符編碼問題導致失敗

2. ✅ **直接使用 Cordova build**
   - 狀態：無法識別 JAVA_HOME 和 ANDROID_HOME 環境變數
   
3. ✅ **使用 Gradle wrapper 直接建置**
   - 狀態：初次執行遇到 `checkDebugAarMetadata` 錯誤
   
4. ✅ **清理並重新建置**
   - 狀態：錯誤持續

5. ✅ **移除並重新安裝 Android 平台**
   - 狀態：平台重新安裝成功，但建置仍失敗

## 根本原因

**環境變數傳遞問題：**
- PowerShell 中使用 `$env:VARIABLE` 設定的環境變數只在當前 PowerShell 會話中有效
- 這些變數無法正確傳遞給由 Cordova 啟動的子程序（Gradle）
- 需要在系統層級設定環境變數或使用批次檔（.bat）來建置

## 解決方案

### 方案 A：使用 Android Studio（最簡單 ✅ 推薦）

這是**最可靠**的方法，不需要處理環境變數問題。

**步驟：**
1. 打開 Android Studio
2. 選擇「Open」並瀏覽到：
   ```
   C:\Users\user\.gemini\antigravity\scratch\pinsheng-quotation\platforms\android
   ```
3. 等待 Gradle 同步完成（首次可能需要幾分鐘）
4. 點擊：Build → Build Bundle(s) / APK(s) → Build APK(s)
5. 建置完成後，點擊通知中的「locate」找到 APK

**APK 位置：**
```
C:\Users\user\.gemini\antigravity\scratch\pinsheng-quotation\platforms\android\app\build\outputs\apk\debug\app-debug.apk
```

---

### 方案 B：設定系統環境變數（需要重啟）

設定永久的系統環境變數，然後使用命令列建置。

**步驟：**

1. **設定環境變數：**
   - 開啟「系統內容」→「進階」→「環境變數」
   - 在「系統變數」中新增或修改：
     - `JAVA_HOME` = `C:\Program Files\Android\Android Studio\jbr`
     - `ANDROID_HOME` = `C:\Users\user\AppData\Local\Android\Sdk`
     - `ANDROID_SDK_ROOT` = `C:\Users\user\AppData\Local\Android\Sdk`
   - 在 `Path` 中添加：
     - `%JAVA_HOME%\bin`
     - `%ANDROID_HOME%\platform-tools`

2. **重新啟動 PowerShell 或命令提示字元**

3. **執行建置：**
   ```batch
   cd C:\Users\user\.gemini\antigravity\scratch\pinsheng-quotation
   cordova build android
   ```

---

### 方案 C：修復批次檔並使用

如果批次檔的編碼問題可以解決，這也是一個好選項。

**步驟：**
1. 使用記事本打開 `完整自動建置.bat`
2. 另存新檔，選擇編碼為「ANSI」或「UTF-8」
3. 雙擊執行該批次檔

---

### 方案 D：手動使用 Gradle（進階）

直接使用 Gradle 但需要先確保環境變數正確。

**步驟：**
1. 開啟新的命令提示字元（cmd.exe，不是 PowerShell）
2. 設定環境變數：
   ```batch
   set JAVA_HOME=C:\Program Files\Android\Android Studio\jbr
   set ANDROID_HOME=C:\Users\user\AppData\Local\Android\Sdk
   set ANDROID_SDK_ROOT=C:\Users\user\AppData\Local\Android\Sdk
   set PATH=%JAVA_HOME%\bin;%ANDROID_HOME%\platform-tools;%PATH%
   ```
3. 切換目錄並建置：
   ```batch
   cd C:\Users\user\.gemini\antigravity\scratch\pinsheng-quotation\platforms\android
   gradlew.bat assembleDebug
   ```

---

## 建議

**強烈建議使用方案 A（Android Studio）**，因為：
- ✅ 最可靠，Android Studio 會自動處理所有環境設定
- ✅ 提供視覺化介面查看建置進度
- ✅ 如果有錯誤，會有清楚的錯誤訊息
- ✅ 不需要手動設定環境變數

---

## 專案檔案狀態

所有程式碼改進都已完成：
- ✅ PDF 匯出功能
- ✅ 資料備份/還原功能
- ✅ Cordova 配置優化
- ✅ 插件安裝完成
- ✅ Android 平台已重新安裝（乾淨的狀態）

**只需執行建置即可獲得 APK！**

---

**日期：** 2026-02-02
